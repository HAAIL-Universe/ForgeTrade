# ForgeTrade — API Physics (v0.1)
# Canonical API specification. If it's not here, it doesn't exist.
# Format: Simplified OpenAPI-style YAML.
#
# NOTE: ForgeTrade is primarily a CLI bot. These endpoints are an
# internal control plane running on localhost for Forge verification
# gates and optional diagnostics. The bot's real work happens in the
# async trading loop, not via HTTP requests.

info:
  title: "ForgeTrade Internal API"
  version: "0.1.0"
  description: "Internal health and status endpoints for ForgeTrade bot"

paths:

  # ── Health ──────────────────────────────────────────────────

  /health:
    get:
      summary: "Health check (required by Forge verification gates)"
      auth: none
      response:
        status: "ok"

  # ── Bot Status ─────────────────────────────────────────────

  /status:
    get:
      summary: "Return current bot state — mode, equity, positions, drawdown"
      auth: none
      response:
        mode: string
        running: boolean
        pair: string
        equity: number | null
        balance: number | null
        peak_equity: number | null
        drawdown_pct: number | null
        circuit_breaker_active: boolean
        open_positions: integer
        last_signal_check: datetime | null
        uptime_seconds: number

  # ── Trade History ──────────────────────────────────────────

  /trades:
    get:
      summary: "Return recent trade log entries"
      auth: none
      query_params:
        limit: integer (default 20)
        status: string (optional, filter by open/closed)
        stream: string (optional, filter by stream_name)
      response:
        trades: TradeRecord[]
        total: integer

  # ── Open Positions ─────────────────────────────────────────

  /positions:
    get:
      summary: "Return current open positions from OANDA"
      auth: none
      response:
        positions: PositionRecord[]

  # ── Pending Signals / Watchlist ────────────────────────────

  /signals/pending:
    get:
      summary: "Return the last evaluated signal (watchlist)"
      auth: none
      response:
        signal: PendingSignal | null

  # ── Closed Trades ──────────────────────────────────────────

  /trades/closed:
    get:
      summary: "Return closed trades with P&L"
      auth: none
      query_params:
        limit: integer (default 20)
        stream: string (optional)
      response:
        trades: TradeRecord[]
        total: integer
        total_pnl: number

  # ── Per-Stream Status ──────────────────────────────────────

  /status/{stream_name}:
    get:
      summary: "Return status for a single stream"
      auth: none
      response:
        StreamStatus

  # ── Dashboard ──────────────────────────────────────────────

  /dashboard:
    mount:
      summary: "Static file mount serving the web dashboard"
      directory: "app/static"
      type: StaticFiles

  /:
    get:
      summary: "Redirect to /dashboard/index.html"
      response:
        redirect: 307 -> /dashboard/index.html

# ── Schemas ──────────────────────────────────────────────────

schemas:

  HealthResponse:
    status: string

  BotStatus:
    mode: string           # "backtest" | "paper" | "live"
    running: boolean
    pair: string
    equity: number | null
    balance: number | null
    peak_equity: number | null
    drawdown_pct: number | null
    circuit_breaker_active: boolean
    open_positions: integer
    last_signal_check: datetime | null
    uptime_seconds: number
    streams: dict[string, StreamStatus]  # keyed by stream name

  StreamStatus:
    stream_name: string
    instrument: string
    strategy: string
    cycle_count: integer
    last_cycle_at: datetime | null
    last_signal_time: datetime | null
    last_order_time: datetime | null
    status: string         # "active" | "off" | "error"

  TradeRecord:
    id: integer
    mode: string
    direction: string      # "buy" | "sell"
    pair: string
    entry_price: number
    exit_price: number | null
    stop_loss: number
    take_profit: number
    units: number
    sr_zone_price: number
    sr_zone_type: string   # "support" | "resistance"
    entry_reason: string
    exit_reason: string | null
    pnl: number | null
    status: string         # "open" | "closed" | "cancelled"
    opened_at: datetime
    closed_at: datetime | null
    stream_name: string | null

  PositionRecord:
    instrument: string
    direction: string      # "long" | "short"
    units: number
    avg_price: number
    unrealized_pnl: number

  PendingSignal:
    pair: string
    direction: string      # "buy" | "sell"
    zone_price: number
    zone_type: string      # "support" | "resistance"
    reason: string
    status: string         # "watching" | "entered" | "no_signal" | "skipped"
    evaluated_at: datetime
    stream_name: string
