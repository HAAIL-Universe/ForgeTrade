<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ForgeTrade Dashboard</title>
<style>
  /* ── Reset & Base ───────────────────────────────────────── */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: #0d1117;
    color: #c9d1d9;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    padding: 16px;
  }

  /* ── Fonts ──────────────────────────────────────────────── */
  .mono { font-family: "JetBrains Mono", "Fira Code", "Cascadia Code", "Consolas", monospace; }

  /* ── Header ─────────────────────────────────────────────── */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 6px;
    margin-bottom: 16px;
  }
  .header h1 { font-size: 18px; font-weight: 700; letter-spacing: 1px; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .mode-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .mode-paper { background: #1f6feb33; color: #58a6ff; border: 1px solid #1f6feb; }
  .mode-live { background: #f8514933; color: #f85149; border: 1px solid #f85149; animation: pulse-red 2s ease-in-out infinite; }
  .mode-backtest { background: #8b5cf633; color: #a78bfa; border: 1px solid #8b5cf6; }
  .mode-idle { background: #30363d; color: #8b949e; border: 1px solid #484f58; }
  @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 4px #f8514966; } 50% { box-shadow: 0 0 12px #f85149aa; } }
  .uptime { color: #8b949e; font-size: 13px; }

  /* ── Cards ──────────────────────────────────────────────── */
  .card {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 6px;
    margin-bottom: 12px;
    overflow: hidden;
  }
  .card-title {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #8b949e;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 16px;
    cursor: pointer;
    user-select: none;
    transition: background 0.15s ease;
    margin: 0;
  }
  .card-title:hover { background: #1c2128; }
  .card-title > span:first-child::before {
    content: '▾';
    display: inline-block;
    margin-right: 8px;
    font-size: 10px;
    transition: transform 0.2s ease;
    color: #6e7681;
  }
  .card.collapsed .card-title > span:first-child::before { transform: rotate(-90deg); }
  .card-body { padding: 0 16px 16px; }
  .card.collapsed .card-body { display: none; }
  .card-title .count { color: #58a6ff; }

  /* ── Metrics Bar ────────────────────────────────────────── */
  .metrics {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 16px;
  }
  .metric {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 16px;
    text-align: center;
  }
  .metric-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #8b949e; margin-bottom: 4px; }
  .metric-value { font-size: 22px; font-weight: 700; }
  .metric-sub { font-size: 12px; margin-top: 2px; }
  .positive { color: #3fb950; }
  .negative { color: #f85149; }
  .neutral { color: #c9d1d9; }

  /* ── Drawdown Bar ───────────────────────────────────────── */
  .dd-bar-container {
    width: 100%;
    height: 8px;
    background: #21262d;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 6px;
  }
  .dd-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
  }
  .dd-yellow { background: #d29922; }
  .dd-orange { background: #db6d28; }
  .dd-red { background: #f85149; }

  /* ── Circuit Breaker ────────────────────────────────────── */
  .cb-off { color: #3fb950; }
  .cb-active { color: #f85149; animation: pulse-red 2s ease-in-out infinite; }

  /* ── Tables ─────────────────────────────────────────────── */
  table { width: 100%; border-collapse: collapse; }
  th {
    text-align: left;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #8b949e;
    padding: 8px 12px;
    border-bottom: 1px solid #30363d;
    font-weight: 600;
  }
  td {
    padding: 8px 12px;
    border-bottom: 1px solid #21262d;
    font-size: 13px;
  }
  tr:hover { background: #1c2128; }
  .empty-row td { text-align: center; color: #484f58; font-style: italic; padding: 24px; }

  /* ── Status Dots ────────────────────────────────────────── */
  .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
  .dot-active { background: #3fb950; }
  .dot-off { background: #484f58; }
  .dot-error { background: #f85149; }

  .stream-row { cursor: pointer; transition: background 0.1s; }
  .stream-row:hover { background: #1c2128; }
  .stream-row.stream-selected { background: #1f6feb1a; border-left: 3px solid #58a6ff; }
  .stream-category { font-size: 10px; color: #6e7681; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-top: 1px; }

  .check-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #21262d; }
  .check-item:last-child { border-bottom: none; }
  .check-icon { font-size: 16px; width: 20px; text-align: center; flex-shrink: 0; }
  .check-pass { color: #3fb950; }
  .check-fail { color: #f85149; }
  .check-wait { color: #d29922; }
  .check-label { color: #8b949e; min-width: 140px; }
  .check-detail { color: #c9d1d9; font-size: 13px; }

  .stream-tabs { display: flex; gap: 0; margin-bottom: 10px; border-bottom: 1px solid #30363d; }
  .stream-tab { padding: 6px 14px; cursor: pointer; color: #8b949e; font-size: 13px; font-weight: 600; border: 1px solid transparent; border-bottom: 2px solid transparent; background: none; transition: all .15s; }
  .stream-tab:hover { color: #c9d1d9; background: #161b2233; }
  .stream-tab.active { color: #58a6ff; border-bottom: 2px solid #58a6ff; }
  .stream-tab .tab-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; }
  .tab-dot-swing { background: #58a6ff; }
  .tab-dot-scalp { background: #f0883e; }

  .tf-trend-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 8px; border-radius: 4px; margin-bottom: 2px; }
  .tf-trend-label { color: #8b949e; font-size: 12px; font-weight: 600; min-width: 40px; }
  .tf-trend-dir { font-size: 13px; font-weight: 700; }
  .tf-bullish { color: #3fb950; }
  .tf-bearish { color: #f85149; }
  .tf-flat { color: #d29922; }
  .tf-expanded .tf-trend-row { display: flex !important; }
  #tf-trend-list:not(.tf-expanded) .tf-trend-row { display: none; }
  #tf-trend-list:not(.tf-expanded) .tf-trend-row.tf-visible { display: flex; }
  .tf-unknown { color: #484f58; }

  .insight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px; }
  @media (max-width: 768px) { .insight-grid { grid-template-columns: 1fr; } }

  .zone-chip { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; margin: 2px 3px; }
  .zone-support { background: #238636aa; color: #3fb950; border: 1px solid #238636; }
  .zone-resistance { background: #da363344; color: #f85149; border: 1px solid #da3633; }
  .zone-nearest { box-shadow: 0 0 6px #58a6ff66; border: 1px solid #58a6ff; }

  .proximity-bar-container { width: 100%; height: 6px; background: #21262d; border-radius: 3px; margin-top: 4px; }
  .proximity-bar { height: 100%; border-radius: 3px; transition: width 0.3s ease; }
  .prox-far { background: #484f58; }
  .prox-mid { background: #d29922; }
  .prox-close { background: #3fb950; }

  .insight-stat { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #21262d; }
  .insight-stat:last-child { border-bottom: none; }
  .insight-stat-label { color: #8b949e; font-size: 13px; }
  .insight-stat-value { font-size: 13px; }

  .readiness-bar-container { width: 100%; height: 10px; background: #21262d; border-radius: 5px; margin-top: 8px; overflow: hidden; }
  .readiness-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease; background: linear-gradient(90deg, #f85149, #d29922, #3fb950); }
  .readiness-pct { text-align: center; font-size: 18px; font-weight: 700; margin-top: 4px; }

  /* ── Settings Panel ─────────────────────────────────────── */
  .settings-row { display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid #21262d; }
  .settings-row:last-child { border-bottom: none; }
  .settings-label { color: #8b949e; font-size: 13px; min-width: 180px; }
  .settings-input {
    background: #0d1117; border: 1px solid #30363d; border-radius: 4px; color: #c9d1d9;
    padding: 6px 10px; font-size: 13px; font-family: inherit; width: 100px; text-align: right;
  }
  .settings-input:focus { outline: none; border-color: #58a6ff; box-shadow: 0 0 4px #1f6feb55; }
  .settings-unit { color: #6e7681; font-size: 12px; min-width: 30px; }
  .settings-hint { color: #484f58; font-size: 11px; margin-left: auto; }
  .btn-save {
    background: #238636; color: #fff; border: none; border-radius: 6px; padding: 8px 20px;
    font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.15s;
  }
  .btn-save:hover { background: #2ea043; }
  .btn-save:disabled { background: #21262d; color: #484f58; cursor: not-allowed; }

  /* ── Control Buttons ────────────────────────────────────── */
  .controls-bar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .btn-ctrl {
    border: none; border-radius: 6px; padding: 8px 16px; font-size: 12px;
    font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
    transition: background 0.15s, box-shadow 0.15s;
  }
  .btn-pause { background: #d2992233; color: #d29922; border: 1px solid #d29922; }
  .btn-pause:hover { background: #d2992255; }
  .btn-resume { background: #23863633; color: #3fb950; border: 1px solid #238636; }
  .btn-resume:hover { background: #23863655; }
  .btn-estop {
    background: #f8514922; color: #f85149; border: 1px solid #f85149;
    animation: none; margin-left: auto;
  }
  .btn-estop:hover { background: #f8514944; box-shadow: 0 0 12px #f8514966; }
  .btn-estop.engaged { animation: pulse-red 1.5s ease-in-out infinite; background: #f8514944; }

  /* ── Footer ─────────────────────────────────────────────── */
  .footer {
    text-align: center;
    color: #484f58;
    font-size: 12px;
    padding: 8px;
    margin-top: 8px;
  }

  /* ── Responsive ─────────────────────────────────────────── */
  @media (max-width: 768px) {
    .metrics { grid-template-columns: repeat(2, 1fr); }
  }

  /* ── Signal / Close Badges ──────────────────────────────── */
  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 3px;
    font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;
  }
  .badge-entered { background: #238636aa; color: #3fb950; border: 1px solid #238636; }
  .badge-watching { background: #1f6feb33; color: #58a6ff; border: 1px solid #1f6feb; }
  .badge-no-signal { background: #21262d; color: #484f58; border: 1px solid #30363d; }
  .badge-error { background: #f8514922; color: #f85149; border: 1px solid #f85149; }
  .badge-tp { background: #238636aa; color: #3fb950; border: 1px solid #238636; }
  .badge-sl { background: #f8514922; color: #f85149; border: 1px solid #f85149; }
  .badge-manual { background: #d2992233; color: #d29922; border: 1px solid #d29922; }
  .badge-closed { background: #30363d; color: #8b949e; border: 1px solid #484f58; }

  /* ── Drag-Reorder ───────────────────────────────────────── */
  .drag-handle {
    cursor: grab; color: #484f58; font-size: 14px; margin-right: 6px;
    user-select: none; -webkit-user-select: none;
    opacity: 0; transition: opacity 0.15s ease;
    letter-spacing: 1px;
  }
  .card-title:hover .drag-handle,
  .card.dragging .drag-handle { opacity: 1; }
  .card.dragging {
    opacity: 0.5; border-color: #58a6ff;
    box-shadow: 0 4px 16px rgba(88, 166, 255, 0.15);
  }
  .card.drag-over-above { border-top: 2px solid #58a6ff; margin-top: -1px; }
  .card.drag-over-below { border-bottom: 2px solid #58a6ff; margin-bottom: -1px; }
  .drag-active .card { transition: transform 0.15s ease; }
</style>
</head>
<body>

<!-- ── Header ──────────────────────────────────────────────── -->
<div class="header">
  <h1>FORGETRADE</h1>
  <div class="header-right">
    <span id="mode-badge" class="mode-badge mode-idle">IDLE</span>
    <span class="uptime mono" id="uptime">▲ 0h0m</span>
  </div>
</div>

<!-- ── Account Metrics ────────────────────────────────────── -->
<div class="metrics">
  <div class="metric">
    <div class="metric-label">Equity</div>
    <div class="metric-value mono" id="equity">—</div>
    <div class="metric-sub mono" id="equity-delta"></div>
  </div>
  <div class="metric">
    <div class="metric-label">Balance</div>
    <div class="metric-value mono" id="balance">—</div>
  </div>
  <div class="metric">
    <div class="metric-label">Unrealised P&L</div>
    <div class="metric-value mono" id="unrealized-pnl">—</div>
  </div>
  <div class="metric">
    <div class="metric-label">Drawdown</div>
    <div class="metric-value mono" id="drawdown">—</div>
    <div class="dd-bar-container"><div class="dd-bar" id="dd-bar"></div></div>
  </div>
</div>
<div class="metrics" style="grid-template-columns: repeat(2, 1fr); margin-top: -4px;">
  <div class="metric">
    <div class="metric-label">Circuit Breaker</div>
    <div class="metric-value" id="circuit-breaker">—</div>
  </div>
  <div class="metric">
    <div class="metric-label">Open Positions</div>
    <div class="metric-value mono" id="open-pos-count">0</div>
  </div>
</div>

<div id="card-container">
<!-- ── Open Positions ─────────────────────────────────────── -->
<div class="card" id="card-positions" draggable="false">
  <div class="card-title" onclick="toggleCard('card-positions')">
    <span><span class="drag-handle" title="Long-press to reorder">⠿</span>Open Positions</span>
    <span class="count mono" id="pos-count">0 open</span>
  </div>
  <div class="card-body">
  <table>
    <thead>
      <tr><th>Pair</th><th>Dir</th><th>Units</th><th>Entry</th><th>SL</th><th>TP</th><th>Opened</th><th>uP&L</th></tr>
    </thead>
    <tbody id="positions-body">
      <tr class="empty-row"><td colspan="8">No open positions</td></tr>
    </tbody>
  </table>
  </div>
</div>

<!-- ── Trade History ──────────────────────────────────────── -->
<div class="card" id="card-closed" draggable="false">
  <div class="card-title" onclick="toggleCard('card-closed')">
    <span><span class="drag-handle" title="Long-press to reorder">⠿</span>Trade History</span>
    <span class="count mono" id="closed-total-pnl"></span>
  </div>
  <div class="card-body">
  <table>
    <thead>
      <tr><th>Pair</th><th>Dir</th><th>Units</th><th>Entry</th><th>Exit</th><th>SL</th><th>TP</th><th>P&L</th><th>Reason</th><th>Duration</th><th>Closed</th></tr>
    </thead>
    <tbody id="closed-body">
      <tr class="empty-row"><td colspan="11">No closed trades</td></tr>
    </tbody>
  </table>
  </div>
</div>

<!-- ── Watchlist ───────────────────────────────────────────── -->
<div class="card" id="card-watchlist" draggable="false">
  <div class="card-title" onclick="toggleCard('card-watchlist')"><span><span class="drag-handle" title="Long-press to reorder">⠿</span>Watchlist</span></div>
  <div class="card-body">
  <table>
    <thead>
      <tr><th>Pair</th><th>Dir</th><th>Zone</th><th>Reason</th><th>Status</th></tr>
    </thead>
    <tbody id="watchlist-body">
      <tr class="empty-row"><td colspan="5">No pending signals</td></tr>
    </tbody>
  </table>
  </div>
</div>

<!-- ── Signal Log ─────────────────────────────────────────── -->
<div class="card collapsed" id="card-signal-log" draggable="false">
  <div class="card-title" onclick="toggleCard('card-signal-log')">
    <span><span class="drag-handle" title="Long-press to reorder">⠿</span>Signal Log</span>
    <span class="count mono" id="signal-log-count">0</span>
  </div>
  <div class="card-body">
  <table>
    <thead>
      <tr><th>Time</th><th>Pair</th><th>Dir</th><th>Status</th><th>Reason</th></tr>
    </thead>
    <tbody id="signal-log-body">
      <tr class="empty-row"><td colspan="5">No signal history</td></tr>
    </tbody>
  </table>
  </div>
</div>

<!-- ── Strategy Insight ───────────────────────────────────── -->
<div class="card" id="card-insight" draggable="false">
  <div class="card-title" onclick="toggleCard('card-insight')">
    <span><span class="drag-handle" title="Long-press to reorder">⠿</span>Strategy Insight</span>
    <span class="count mono" id="insight-strategy">—</span>
  </div>
  <div class="card-body">

  <!-- Stream tabs -->
  <div class="stream-tabs" id="insight-tabs"></div>

  <!-- Readiness -->
  <div style="padding: 0 4px 8px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <span class="metric-label" style="margin:0;">Entry Readiness</span>
      <span class="readiness-pct mono" id="readiness-pct">0%</span>
    </div>
    <div class="readiness-bar-container">
      <div class="readiness-bar" id="readiness-bar" style="width:0%"></div>
    </div>
  </div>

  <!-- Checklist + Details side by side -->
  <div class="insight-grid">
    <!-- LEFT: Checklist (dynamically populated) -->
    <div id="insight-checklist"></div>

    <!-- RIGHT: Details (dynamically populated) -->
    <div id="insight-detail-panel"></div>
  </div>
  </div>
</div>

<!-- ── Streams ─────────────────────────────────────────────── -->
<div class="card" id="card-streams" draggable="false">
  <div class="card-title" onclick="toggleCard('card-streams')"><span><span class="drag-handle" title="Long-press to reorder">⠿</span>Streams</span></div>
  <div class="card-body">
  <table>
    <thead>
      <tr><th>Name</th><th>Instrument</th><th>Cycle</th><th>Status</th><th>Last Signal</th></tr>
    </thead>
    <tbody id="streams-body">
      <tr class="empty-row"><td colspan="5">No stream data</td></tr>
    </tbody>
  </table>
  </div>
</div>

<!-- ── Controls ────────────────────────────────────────────── -->
<div class="card" id="card-controls" draggable="false">
  <div class="card-title" onclick="toggleCard('card-controls')"><span><span class="drag-handle" title="Long-press to reorder">⠿</span>Controls</span></div>
  <div class="card-body">
    <div class="controls-bar">
      <button class="btn-ctrl btn-pause" id="btn-pause" onclick="pauseAll()">⏸ Pause All</button>
      <button class="btn-ctrl btn-resume" id="btn-resume" onclick="resumeAll()" style="display:none">▶ Resume All</button>
      <button class="btn-ctrl btn-estop" id="btn-estop" onclick="emergencyStop()">⛔ Emergency Stop</button>
    </div>
  </div>
</div>

<!-- ── Settings ────────────────────────────────────────────── -->
<div class="card collapsed" id="card-settings" draggable="false">
  <div class="card-title" onclick="toggleCard('card-settings')"><span><span class="drag-handle" title="Long-press to reorder">⠿</span>Settings</span></div>
  <div class="card-body">
    <div class="settings-row">
      <span class="settings-label">Risk Per Trade</span>
      <input class="settings-input mono" type="number" id="set-risk" step="0.1" min="0.1" max="5.0" value="1.0">
      <span class="settings-unit">%</span>
      <span class="settings-hint">0.1 – 5.0%</span>
    </div>
    <div class="settings-row">
      <span class="settings-label">Risk : Reward Ratio</span>
      <input class="settings-input mono" type="number" id="set-rr" step="0.1" min="1.0" max="5.0" value="2.0">
      <span class="settings-unit">R</span>
      <span class="settings-hint">1.0 – 5.0 R</span>
    </div>
    <div class="settings-row">
      <span class="settings-label">Max Drawdown</span>
      <input class="settings-input mono" type="number" id="set-dd" step="0.5" min="1.0" max="25.0" value="10.0">
      <span class="settings-unit">%</span>
      <span class="settings-hint">Circuit breaker threshold</span>
    </div>
    <div class="settings-row">
      <span class="settings-label">Session Start (UTC)</span>
      <input class="settings-input mono" type="number" id="set-sess-start" step="1" min="0" max="23" value="7">
      <span class="settings-unit">h</span>
      <span class="settings-hint">0 – 23</span>
    </div>
    <div class="settings-row">
      <span class="settings-label">Session End (UTC)</span>
      <input class="settings-input mono" type="number" id="set-sess-end" step="1" min="0" max="23" value="21">
      <span class="settings-unit">h</span>
      <span class="settings-hint">0 – 23</span>
    </div>
    <div class="settings-row">
      <span class="settings-label">Max Concurrent Positions</span>
      <input class="settings-input mono" type="number" id="set-max-pos" step="1" min="1" max="10" value="1">
      <span class="settings-unit"></span>
      <span class="settings-hint">Per instrument</span>
    </div>
    <div class="settings-row">
      <span class="settings-label">Poll Interval</span>
      <input class="settings-input mono" type="number" id="set-poll" step="10" min="10" max="3600" value="300">
      <span class="settings-unit">sec</span>
      <span class="settings-hint">10 – 3600s</span>
    </div>
    <div style="display:flex; gap:10px; margin-top:12px; align-items:center;">
      <button class="btn-save" id="btn-save" onclick="saveSettings()">Save Settings</button>
      <span class="mono" id="save-status" style="font-size:12px; color:#3fb950;"></span>
    </div>
  </div>
</div>
</div><!-- /card-container -->

<!-- ── Footer ─────────────────────────────────────────────── -->
<div class="footer">
  Last refresh: <span class="mono" id="last-refresh">—</span> &nbsp;|&nbsp; Polling: every 5s
</div>

<script>
// ── Global: collapse toggle (accessed by onclick) ──────────
function toggleCard(id) {
  var card = document.getElementById(id);
  if (card) card.classList.toggle('collapsed');
  // Persist state
  try {
    var state = JSON.parse(localStorage.getItem('ft_collapsed') || '{}');
    state[id] = card.classList.contains('collapsed');
    localStorage.setItem('ft_collapsed', JSON.stringify(state));
  } catch(e) {}
}
// Restore collapsed state on load
(function() {
  try {
    var state = JSON.parse(localStorage.getItem('ft_collapsed') || '{}');
    Object.keys(state).forEach(function(id) {
      var el = document.getElementById(id);
      if (el && state[id]) el.classList.add('collapsed');
      else if (el && !state[id]) el.classList.remove('collapsed');
    });
  } catch(e) {}
})();

// ── Drag-to-reorder cards (long-press) ─────────────────────
(function() {
  var container = document.getElementById('card-container');
  if (!container) return;

  var STORAGE_KEY = 'ft_card_order';
  var LONG_PRESS_MS = 400;
  var pressTimer = null;
  var dragSrcEl = null;

  /* ── Restore saved order on load ── */
  try {
    var saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if (saved.length) {
      saved.forEach(function(id) {
        var el = document.getElementById(id);
        if (el) container.appendChild(el);
      });
    }
  } catch(e) {}

  /* ── Save current order ── */
  function saveOrder() {
    var ids = [];
    container.querySelectorAll('.card').forEach(function(c) { ids.push(c.id); });
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(ids)); } catch(e) {}
  }

  /* ── Clear drag indicators ── */
  function clearIndicators() {
    container.querySelectorAll('.card').forEach(function(c) {
      c.classList.remove('drag-over-above', 'drag-over-below');
    });
  }

  /* ── Activate drag mode ── */
  function activateDrag(card) {
    card.setAttribute('draggable', 'true');
    container.classList.add('drag-active');
    // Trigger dragstart programmatically isn't reliable; user must move mouse.
    // Visual cue that they can now drag:
    card.classList.add('dragging');
  }

  function deactivateDrag() {
    container.querySelectorAll('.card').forEach(function(c) {
      c.setAttribute('draggable', 'false');
      c.classList.remove('dragging');
    });
    container.classList.remove('drag-active');
    clearIndicators();
  }

  /* ── Long-press detection on drag handles ── */
  container.addEventListener('mousedown', function(e) {
    var handle = e.target.closest('.drag-handle');
    if (!handle) return;
    e.preventDefault();
    var card = handle.closest('.card');
    if (!card) return;
    pressTimer = setTimeout(function() {
      activateDrag(card);
    }, LONG_PRESS_MS);
  });
  container.addEventListener('mouseup', function() { clearTimeout(pressTimer); });
  container.addEventListener('mouseleave', function() { clearTimeout(pressTimer); });

  /* ── Touch long-press ── */
  container.addEventListener('touchstart', function(e) {
    var handle = e.target.closest('.drag-handle');
    if (!handle) return;
    var card = handle.closest('.card');
    if (!card) return;
    pressTimer = setTimeout(function() {
      activateDrag(card);
    }, LONG_PRESS_MS);
  }, { passive: true });
  container.addEventListener('touchend', function() { clearTimeout(pressTimer); });

  /* ── HTML5 Drag Events ── */
  container.addEventListener('dragstart', function(e) {
    var card = e.target.closest('.card');
    if (!card) return;
    dragSrcEl = card;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', card.id);
    setTimeout(function() { card.classList.add('dragging'); }, 0);
  });

  container.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    var card = e.target.closest('.card');
    if (!card || card === dragSrcEl) { clearIndicators(); return; }
    clearIndicators();
    var rect = card.getBoundingClientRect();
    var midY = rect.top + rect.height / 2;
    if (e.clientY < midY) {
      card.classList.add('drag-over-above');
    } else {
      card.classList.add('drag-over-below');
    }
  });

  container.addEventListener('dragleave', function(e) {
    var card = e.target.closest('.card');
    if (card) {
      card.classList.remove('drag-over-above', 'drag-over-below');
    }
  });

  container.addEventListener('drop', function(e) {
    e.preventDefault();
    var target = e.target.closest('.card');
    if (!target || !dragSrcEl || target === dragSrcEl) return;
    var rect = target.getBoundingClientRect();
    var midY = rect.top + rect.height / 2;
    if (e.clientY < midY) {
      container.insertBefore(dragSrcEl, target);
    } else {
      container.insertBefore(dragSrcEl, target.nextSibling);
    }
    saveOrder();
  });

  container.addEventListener('dragend', function() {
    deactivateDrag();
    dragSrcEl = null;
  });

  /* ── Click anywhere outside a handle cancels drag mode ── */
  document.addEventListener('mousedown', function(e) {
    if (!e.target.closest('.drag-handle') && container.classList.contains('drag-active')) {
      deactivateDrag();
    }
  });
})();

// ── Global: control actions (accessed by onclick) ──────────
// ── Global: instrument display names ───────────────────
var INSTRUMENT_DISPLAY = {
  'XAU_USD': { name: 'Gold', category: 'Commodities' },
  'XAG_USD': { name: 'Silver', category: 'Commodities' },
  'XPT_USD': { name: 'Platinum', category: 'Commodities' },
  'WTICO_USD': { name: 'WTI Oil', category: 'Commodities' },
  'NATGAS_USD': { name: 'Natural Gas', category: 'Commodities' },
};
function instrumentLabel(inst) {
  var info = INSTRUMENT_DISPLAY[inst];
  if (info) return info.name;
  return (inst || '').replace('_', '/');
}
function instrumentCategory(inst) {
  var info = INSTRUMENT_DISPLAY[inst];
  return info ? info.category : 'Forex';
}

// ── Global: insight tab selection (must be global for onclick) ──
function selectInsightTab(streamName) {
  if (typeof window._setInsightTab === 'function') window._setInsightTab(streamName);
}

function pauseAll() {
  fetch('/control/pause', {method:'POST'}).then(function() {
    document.getElementById('btn-pause').style.display = 'none';
    document.getElementById('btn-resume').style.display = '';
  }).catch(function(e) { console.error('Pause failed:', e); });
}
function resumeAll() {
  fetch('/control/resume', {method:'POST'}).then(function() {
    document.getElementById('btn-resume').style.display = 'none';
    document.getElementById('btn-pause').style.display = '';
  }).catch(function(e) { console.error('Resume failed:', e); });
}
function emergencyStop() {
  if (!confirm('EMERGENCY STOP — This will immediately halt ALL streams. Continue?')) return;
  document.getElementById('btn-estop').classList.add('engaged');
  fetch('/control/emergency-stop', {method:'POST'}).then(function() {
    document.getElementById('btn-pause').style.display = 'none';
    document.getElementById('btn-resume').style.display = 'none';
  }).catch(function(e) { console.error('Emergency stop failed:', e); });
}
function saveSettings() {
  var data = {
    risk_per_trade_pct: parseFloat(document.getElementById('set-risk').value),
    rr_ratio: parseFloat(document.getElementById('set-rr').value),
    max_drawdown_pct: parseFloat(document.getElementById('set-dd').value),
    session_start_utc: parseInt(document.getElementById('set-sess-start').value),
    session_end_utc: parseInt(document.getElementById('set-sess-end').value),
    max_concurrent_positions: parseInt(document.getElementById('set-max-pos').value),
    poll_interval_seconds: parseInt(document.getElementById('set-poll').value),
  };
  var statusEl = document.getElementById('save-status');
  statusEl.textContent = 'Saving...';
  statusEl.style.color = '#d29922';
  fetch('/settings', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  }).then(function(r) {
    if (!r.ok) throw new Error(r.status);
    return r.json();
  }).then(function() {
    statusEl.textContent = '✓ Saved';
    statusEl.style.color = '#3fb950';
    setTimeout(function() { statusEl.textContent = ''; }, 3000);
  }).catch(function(e) {
    statusEl.textContent = '✗ Error: ' + e.message;
    statusEl.style.color = '#f85149';
  });
}

(function() {
  'use strict';

  const POLL_MS = 5000;

  // ── Helpers ──────────────────────────────────────────────

  function $(id) { return document.getElementById(id); }

  function fmt$(v) {
    if (v == null) return '—';
    var n = parseFloat(v);
    return isNaN(n) ? '—' : '$' + n.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  function fmtPct(v) {
    if (v == null) return '—';
    return parseFloat(v).toFixed(2) + '%';
  }

  function fmtPrice(v, digits) {
    if (v == null) return '—';
    return parseFloat(v).toFixed(digits || 5);
  }

  function fmtTime(iso) {
    if (!iso) return '—';
    var d = new Date(iso);
    return d.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'UTC'}) + ' UTC';
  }

  function fmtDateTime(iso) {
    if (!iso) return '—';
    var d = new Date(iso);
    var date = d.toLocaleDateString('en-GB', {day: '2-digit', month: 'short', timeZone: 'UTC'});
    var time = d.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit', timeZone: 'UTC'});
    return date + ' ' + time;
  }

  function fmtDuration(openIso, closeIso) {
    if (!openIso || !closeIso) return '—';
    var ms = new Date(closeIso) - new Date(openIso);
    if (ms < 0) return '—';
    var secs = Math.floor(ms / 1000);
    if (secs < 60) return secs + 's';
    var mins = Math.floor(secs / 60);
    if (mins < 60) return mins + 'm';
    var hrs = Math.floor(mins / 60);
    var remMins = mins % 60;
    if (hrs < 24) return hrs + 'h ' + remMins + 'm';
    var days = Math.floor(hrs / 24);
    return days + 'd ' + (hrs % 24) + 'h';
  }

  function signalBadge(status) {
    if (!status) return '<span class="badge badge-no-signal">—</span>';
    var s = status.toLowerCase();
    if (s === 'entered') return '<span class="badge badge-entered">entered</span>';
    if (s === 'watching') return '<span class="badge badge-watching">watching</span>';
    if (s === 'error') return '<span class="badge badge-error">error</span>';
    if (s === 'no_signal') return '<span class="badge badge-no-signal">no signal</span>';
    return '<span class="badge badge-closed">' + status + '</span>';
  }

  function closeReasonBadge(reason) {
    if (!reason) return '<span class="badge badge-closed">closed</span>';
    var r = reason.toUpperCase();
    if (r.indexOf('TAKE_PROFIT') >= 0) return '<span class="badge badge-tp">TP hit</span>';
    if (r.indexOf('STOP_LOSS') >= 0) return '<span class="badge badge-sl">SL hit</span>';
    if (r.indexOf('MARKET') >= 0 || r.indexOf('CLIENT') >= 0) return '<span class="badge badge-manual">manual</span>';
    return '<span class="badge badge-closed">' + reason.toLowerCase() + '</span>';
  }

  function pnlClass(v) {
    if (v == null) return 'neutral';
    return parseFloat(v) >= 0 ? 'positive' : 'negative';
  }

  function formatUptime(secs) {
    if (!secs || secs <= 0) return '▲ 0h0m';
    var h = Math.floor(secs / 3600);
    var m = Math.floor((secs % 3600) / 60);
    return '▲ ' + h + 'h' + m + 'm';
  }

  // ── Fetch with error handling ────────────────────────────

  function fetchJSON(url) {
    return fetch(url).then(function(r) {
      if (!r.ok) throw new Error(r.status);
      return r.json();
    });
  }

  // ── Update Functions ─────────────────────────────────────

  function updateStatus(raw) {
    // /status returns {"streams": {"name": {...}, ...}}
    var streams = raw.streams || {};
    var keys = Object.keys(streams);

    // Pick the first active stream for the header cards, or first stream
    var data = {};
    for (var i = 0; i < keys.length; i++) {
      if (streams[keys[i]].running) { data = streams[keys[i]]; break; }
    }
    if (!data.mode && keys.length > 0) data = streams[keys[0]];

    // Mode badge
    var badge = $('mode-badge');
    var mode = (data.mode || 'idle').toLowerCase();
    badge.textContent = mode.toUpperCase();
    badge.className = 'mode-badge mode-' + mode;

    // Uptime
    $('uptime').textContent = formatUptime(data.uptime_seconds);

    // Equity
    var eq = data.equity;
    var bal = data.balance;
    $('equity').textContent = fmt$(eq);
    $('balance').textContent = fmt$(bal);

    if (eq != null && bal != null) {
      var delta = eq - bal;
      var el = $('equity-delta');
      el.textContent = (delta >= 0 ? '+' : '') + fmt$(delta);
      el.className = 'metric-sub mono ' + pnlClass(delta);
    }

    // Drawdown
    var dd = data.drawdown_pct;
    $('drawdown').textContent = fmtPct(dd);
    var bar = $('dd-bar');
    var ddVal = parseFloat(dd) || 0;
    bar.style.width = Math.min(ddVal * 10, 100) + '%';
    bar.className = 'dd-bar ' + (ddVal < 5 ? 'dd-yellow' : ddVal < 8 ? 'dd-orange' : 'dd-red');

    // Circuit breaker
    var cb = $('circuit-breaker');
    if (data.circuit_breaker_active) {
      cb.innerHTML = '<span class="cb-active">● ACTIVE</span>';
    } else {
      cb.innerHTML = '<span class="cb-off">● OFF</span>';
    }

    // Streams table — render ALL streams
    var tbody = $('streams-body');
    if (keys.length === 0) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="5">No streams configured</td></tr>';
      return;
    }

    var html = '';
    for (var j = 0; j < keys.length; j++) {
      var s = streams[keys[j]];
      var sName = s.stream_name || keys[j];
      var pair = s.pair || '—';
      var cycle = s.cycle_count || 0;
      var st = s.running ? 'active' : 'off';
      var dotClass = st === 'active' ? 'dot-active' : 'dot-off';
      var lastSig = s.last_signal_time ? fmtTime(s.last_signal_time) : '—';
      var dispName = instrumentLabel(pair);
      var cat = instrumentCategory(pair);
      var isSelected = (_activeInsightTab === keys[j]) ? ' stream-selected' : '';
      html +=
        '<tr class="stream-row' + isSelected + '" onclick="selectInsightTab(\'' + keys[j] + '\')">' +
        '<td>' + sName + '</td>' +
        '<td class="mono">' + dispName + '<span class="stream-category">' + cat + '</span></td>' +
        '<td class="mono">' + cycle + '</td>' +
        '<td><span class="dot ' + dotClass + '"></span>' + st + '</td>' +
        '<td class="mono">' + lastSig + '</td>' +
        '</tr>';
    }
    tbody.innerHTML = html;
  }

  function updatePositions(data) {
    var positions = data.positions || [];
    var tbody = $('positions-body');
    $('pos-count').textContent = positions.length + ' open';

    if (positions.length === 0) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="8">No open positions</td></tr>';
      return;
    }

    var html = '';
    for (var i = 0; i < positions.length; i++) {
      var p = positions[i];
      var digits = p.instrument && p.instrument.indexOf('XAU') >= 0 ? 2 : 5;
      var slText = p.stop_loss != null ? fmtPrice(p.stop_loss, digits) : '—';
      var tpText = p.take_profit != null ? fmtPrice(p.take_profit, digits) : '—';
      var openedText = p.open_time ? fmtDateTime(p.open_time) : '—';
      html +=
        '<tr>' +
        '<td>' + (p.instrument || '—').replace('_', '/') + '</td>' +
        '<td>' + (p.direction || '—').toUpperCase() + '</td>' +
        '<td class="mono">' + (p.units || 0) + '</td>' +
        '<td class="mono">' + fmtPrice(p.avg_price, digits) + '</td>' +
        '<td class="mono">' + slText + '</td>' +
        '<td class="mono">' + tpText + '</td>' +
        '<td class="mono">' + openedText + '</td>' +
        '<td class="mono ' + pnlClass(p.unrealized_pnl) + '">' + fmt$(p.unrealized_pnl) + '</td>' +
        '</tr>';
    }
    tbody.innerHTML = html;
  }

  function updateWatchlist(data) {
    var s = data.signal;
    var tbody = $('watchlist-body');

    if (!s || s.status === 'no_signal') {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="5">No pending signals</td></tr>';
      return;
    }

    var dir = s.direction ? s.direction.toUpperCase() : '—';
    var zone = s.zone_price != null ? fmtPrice(s.zone_price) : '—';
    var statusBadge = s.status || '—';

    tbody.innerHTML =
      '<tr>' +
      '<td>' + (s.pair || '—').replace('_', '/') + '</td>' +
      '<td>' + dir + '</td>' +
      '<td class="mono">' + zone + '</td>' +
      '<td>' + (s.reason || '—') + '</td>' +
      '<td>' + statusBadge + '</td>' +
      '</tr>';
  }

  function updateSignalLog(data) {
    var signals = data.signals || [];
    var tbody = $('signal-log-body');
    $('signal-log-count').textContent = signals.length;

    if (signals.length === 0) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="5">No signal history</td></tr>';
      return;
    }

    var html = '';
    for (var i = 0; i < signals.length; i++) {
      var sig = signals[i];
      var t = sig.evaluated_at ? sig.evaluated_at.substring(11, 19) : '—';
      var dirCls = sig.direction === 'buy' ? 'pnl-pos' : (sig.direction === 'sell' ? 'pnl-neg' : '');
      html +=
        '<tr>' +
        '<td class="mono">' + t + '</td>' +
        '<td>' + (sig.pair || '—').replace('_', '/') + '</td>' +
        '<td class="' + dirCls + '">' + (sig.direction || '—').toUpperCase() + '</td>' +
        '<td>' + signalBadge(sig.status) + '</td>' +
        '<td>' + (sig.reason || '—') + '</td>' +
        '</tr>';
    }
    tbody.innerHTML = html;
  }

  function updateClosedTrades(data) {
    var trades = data.trades || [];
    var tbody = $('closed-body');
    var totalPnl = data.total_pnl || 0;

    var pnlEl = $('closed-total-pnl');
    pnlEl.textContent = 'Total: ' + fmt$(totalPnl);
    pnlEl.className = 'count mono ' + pnlClass(totalPnl);

    if (trades.length === 0) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="11">No closed trades</td></tr>';
      return;
    }

    var html = '';
    for (var i = 0; i < trades.length; i++) {
      var t = trades[i];
      var digits = t.pair && t.pair.indexOf('XAU') >= 0 ? 2 : 5;
      html +=
        '<tr>' +
        '<td>' + (t.pair || '—').replace('_', '/') + '</td>' +
        '<td>' + (t.direction || '—').toUpperCase() + '</td>' +
        '<td class="mono">' + (t.units != null ? Math.abs(t.units).toLocaleString() : '—') + '</td>' +
        '<td class="mono">' + fmtPrice(t.entry_price, digits) + '</td>' +
        '<td class="mono">' + fmtPrice(t.exit_price, digits) + '</td>' +
        '<td class="mono">' + fmtPrice(t.stop_loss, digits) + '</td>' +
        '<td class="mono">' + fmtPrice(t.take_profit, digits) + '</td>' +
        '<td class="mono ' + pnlClass(t.pnl) + '">' + fmt$(t.pnl) + '</td>' +
        '<td>' + closeReasonBadge(t.close_reason) + '</td>' +
        '<td class="mono">' + fmtDuration(t.opened_at, t.closed_at) + '</td>' +
        '<td class="mono">' + fmtDateTime(t.closed_at) + '</td>' +
        '</tr>';
    }
    tbody.innerHTML = html;
  }

  // ── Strategy Insight ──────────────────────────────────────

  var _insightData = {};        // All stream insights
  var _activeInsightTab = null; // Currently selected stream name

  function checkHtml(id, label) {
    return '<div class="check-item" id="' + id + '">' +
      '<span class="check-icon check-wait">◯</span>' +
      '<span class="check-label">' + label + '</span>' +
      '<span class="check-detail mono" id="' + id + '-detail">—</span>' +
      '</div>';
  }
  function setCheckDyn(id, pass, detail) {
    var el = $(id);
    if (!el) return;
    var icon = el.querySelector('.check-icon');
    var detailEl = $(id + '-detail');
    if (pass === true) { icon.textContent = '✓'; icon.className = 'check-icon check-pass'; }
    else if (pass === false) { icon.textContent = '✗'; icon.className = 'check-icon check-fail'; }
    else { icon.textContent = '◯'; icon.className = 'check-icon check-wait'; }
    if (detailEl) detailEl.textContent = detail || '—';
  }

  function updateInsight(data) {
    _insightData = data.insights || {};
    var keys = Object.keys(_insightData);
    if (keys.length === 0) {
      $('insight-strategy').textContent = 'Waiting...';
      $('readiness-pct').textContent = '0%';
      $('readiness-bar').style.width = '0%';
      $('insight-tabs').innerHTML = '';
      $('insight-checklist').innerHTML = '';
      $('insight-detail-panel').innerHTML = '';
      return;
    }

    // Build stream tabs
    var tabsHtml = '';
    for (var ti = 0; ti < keys.length; ti++) {
      var sn = keys[ti];
      var isScalp = sn.indexOf('scalp') >= 0;
      var dotClass = isScalp ? 'tab-dot-scalp' : 'tab-dot-swing';
      var pair = _insightData[sn].pair || '';
      var label = instrumentLabel(pair) || sn;
      tabsHtml += '<div class="stream-tab' + (_activeInsightTab === sn || (!_activeInsightTab && ti === 0) ? ' active' : '') +
        '" data-stream="' + sn + '" onclick="selectInsightTab(\'' + sn + '\')">' +
        '<span class="tab-dot ' + dotClass + '"></span>' + label + '</div>';
    }
    $('insight-tabs').innerHTML = tabsHtml;

    // Auto-select first tab if none active
    if (!_activeInsightTab || keys.indexOf(_activeInsightTab) < 0) {
      _activeInsightTab = keys[0];
    }

    renderInsightForStream(_activeInsightTab);
  }

  // selectInsightTab implementation (exposed as window._setInsightTab)
  window._setInsightTab = function(streamName) {
    _activeInsightTab = streamName;
    // Re-render tabs active state
    var tabs = document.querySelectorAll('.stream-tab');
    for (var t = 0; t < tabs.length; t++) {
      tabs[t].classList.toggle('active', tabs[t].getAttribute('data-stream') === streamName);
    }
    // Re-highlight selected stream row
    var rows = document.querySelectorAll('.stream-row');
    for (var r = 0; r < rows.length; r++) {
      rows[r].classList.remove('stream-selected');
    }
    var selRow = document.querySelector('.stream-row[onclick*="' + streamName + '"]');
    if (selRow) selRow.classList.add('stream-selected');
    renderInsightForStream(streamName);
  };

  function renderInsightForStream(streamName) {
    var ins = _insightData[streamName];
    if (!ins) return;
    var checks = ins.checks || {};
    var isScalp = (ins.strategy || '').toLowerCase().indexOf('scalp') >= 0;

    $('insight-strategy').textContent = (ins.strategy || '—').toUpperCase() + ' · ' + instrumentLabel(ins.pair || '');

    var checklistEl = $('insight-checklist');
    var detailEl = $('insight-detail-panel');

    if (isScalp) {
      renderScalpChecklist(ins, checks, checklistEl);
      renderScalpDetails(ins, detailEl);
    } else {
      renderSwingChecklist(ins, checks, checklistEl);
      renderSwingDetails(ins, detailEl);
    }

    // Readiness percentage
    var checkKeys = Object.keys(checks);
    var passed = 0;
    for (var i = 0; i < checkKeys.length; i++) {
      if (checks[checkKeys[i]] === true) passed++;
    }
    var pct = checkKeys.length > 0 ? Math.round((passed / checkKeys.length) * 100) : 0;
    $('readiness-pct').textContent = pct + '%';
    $('readiness-pct').className = 'readiness-pct mono ' + (pct >= 100 ? 'check-pass' : pct >= 50 ? 'check-wait' : 'check-fail');
    $('readiness-bar').style.width = pct + '%';
  }

  // ── SR Rejection (swing) checklist ──────
  function renderSwingChecklist(ins, checks, el) {
    el.innerHTML =
      checkHtml('chk-circuit', 'Circuit Breaker') +
      checkHtml('chk-session', 'Session Window') +
      checkHtml('chk-zones', 'S/R Zones') +
      checkHtml('chk-proximity', 'Zone Proximity') +
      checkHtml('chk-wick', 'Rejection Wick') +
      checkHtml('chk-risk', 'Risk / SL+TP');

    setCheckDyn('chk-circuit', checks.circuit_breaker_clear,
      checks.circuit_breaker_clear ? 'Clear' : 'ACTIVE — trading halted');
    setCheckDyn('chk-session', checks.in_session,
      checks.in_session ? 'In session' : 'Outside hours');

    var zoneDetail = '—';
    if (ins.zones) zoneDetail = ins.zones.total + ' zones (' + ins.zones.support.length + 'S / ' + ins.zones.resistance.length + 'R)';
    setCheckDyn('chk-zones', checks.zones_detected, zoneDetail);

    var proxDetail = '—';
    if (ins.nearest_zone) proxDetail = ins.nearest_zone.distance_pips + ' pips to ' + ins.nearest_zone.type;
    setCheckDyn('chk-proximity', checks.zone_proximity, proxDetail);

    var wickDetail = '—';
    if (ins.latest_h4) {
      var h4 = ins.latest_h4;
      var parts = [];
      if (h4.buy_rejection_wick) parts.push('Bull wick ✓');
      if (h4.sell_rejection_wick) parts.push('Bear wick ✓');
      if (parts.length === 0) parts.push('No rejection');
      if (h4.zones_touched > 0) parts.push(h4.zones_touched + ' zone(s) touched');
      else parts.push('No zone touch');
      wickDetail = parts.join(' · ');
    }
    setCheckDyn('chk-wick', checks.rejection_wick, wickDetail);

    var riskDetail = '—';
    if (ins.signal) {
      riskDetail = ins.signal.direction.toUpperCase() + ' @ ' + ins.signal.entry +
        ' SL:' + ins.signal.sl + ' TP:' + ins.signal.tp;
    }
    setCheckDyn('chk-risk', checks.risk_calculated, riskDetail);
  }

  function renderSwingDetails(ins, el) {
    var html = '';
    // Zone map
    html += '<div style="color:#8b949e; font-size:12px; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px;">Zone Map</div>';
    if (ins.zones && (ins.zones.support.length > 0 || ins.zones.resistance.length > 0)) {
      var chips = '';
      for (var si = 0; si < ins.zones.support.length; si++) {
        var sz = ins.zones.support[si];
        var isN = ins.nearest_zone && Math.abs(sz.price - ins.nearest_zone.price) < 0.00001;
        chips += '<span class="zone-chip zone-support ' + (isN ? 'zone-nearest' : '') + '">S ' + sz.price.toFixed(5) + ' (' + sz.touches + ')</span>';
      }
      for (var ri = 0; ri < ins.zones.resistance.length; ri++) {
        var rz = ins.zones.resistance[ri];
        var isNR = ins.nearest_zone && Math.abs(rz.price - ins.nearest_zone.price) < 0.00001;
        chips += '<span class="zone-chip zone-resistance ' + (isNR ? 'zone-nearest' : '') + '">R ' + rz.price.toFixed(5) + ' (' + rz.touches + ')</span>';
      }
      html += '<div style="min-height:28px;">' + chips + '</div>';
    } else {
      html += '<div style="min-height:28px;">No zones</div>';
    }

    // Nearest Zone section (distance / proximity bar)
    html += '<div style="margin-top:12px; color:#8b949e; font-size:12px; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px;">Nearest Zone</div>';
    if (ins.nearest_zone) {
      html += '<div class="insight-stat"><span class="insight-stat-label">Level</span><span class="insight-stat-value mono">' + ins.nearest_zone.price.toFixed(5) + '</span></div>';
      html += '<div class="insight-stat"><span class="insight-stat-label">Type</span><span class="insight-stat-value mono">' + ins.nearest_zone.type.toUpperCase() + '</span></div>';
      html += '<div class="insight-stat"><span class="insight-stat-label">Distance</span><span class="insight-stat-value mono">' + ins.nearest_zone.distance_pips + ' pips</span></div>';
      var proxPct = Math.max(0, Math.min(100, (1 - ins.nearest_zone.distance_pips / 50) * 100));
      var proxClass = proxPct > 60 ? 'prox-close' : proxPct > 30 ? 'prox-mid' : 'prox-far';
      html += '<div class="proximity-bar-container"><div class="proximity-bar ' + proxClass + '" style="width:' + proxPct + '%"></div></div>';
    } else {
      html += '<div style="color:#484f58; font-size:13px;">No zones detected</div>';
    }

    // Stats
    html += '<div style="margin-top:12px;"><div class="insight-stat"><span class="insight-stat-label">Price</span><span class="insight-stat-value mono">' +
      (ins.current_price ? ins.current_price.toFixed(5) : '—') + '</span></div>';
    html += '<div class="insight-stat"><span class="insight-stat-label">ATR (Daily)</span><span class="insight-stat-value mono">' +
      (ins.atr ? ins.atr.toFixed(5) : '—') + '</span></div>';
    if (ins.latest_h4) {
      html += '<div class="insight-stat"><span class="insight-stat-label">Last H4</span><span class="insight-stat-value mono">O:' +
        ins.latest_h4.open.toFixed(5) + ' H:' + ins.latest_h4.high.toFixed(5) + ' L:' + ins.latest_h4.low.toFixed(5) + ' C:' + ins.latest_h4.close.toFixed(5) + '</span></div>';
    }
    html += '</div>';
    el.innerHTML = html;
  }

  // ── Trend Scalp checklist ──────
  function renderScalpChecklist(ins, checks, el) {
    el.innerHTML =
      checkHtml('chk-circuit', 'Circuit Breaker') +
      checkHtml('chk-session', 'Session Window') +
      checkHtml('chk-trend', 'Bias (M1)') +
      checkHtml('chk-spread', 'Spread Filter') +
      checkHtml('chk-pullback', 'EMA Pullback') +
      checkHtml('chk-confirm', 'Candle Pattern') +
      checkHtml('chk-sl', 'SL Valid') +
      checkHtml('chk-risk', 'Risk / SL+TP');

    setCheckDyn('chk-circuit', checks.circuit_breaker_clear,
      checks.circuit_breaker_clear ? 'Clear' : 'ACTIVE — trading halted');
    setCheckDyn('chk-session', checks.in_session,
      checks.in_session ? 'In session' : 'Outside hours');

    // Trend
    var trendDetail = '—';
    if (ins.trend) {
      trendDetail = ins.trend.direction.toUpperCase() + ' (slope: ' + ins.trend.slope + ')';
    }
    setCheckDyn('chk-trend', checks.trend_detected, trendDetail);

    // Spread
    var spreadDetail = '—';
    if (ins.spread_pips !== undefined) {
      spreadDetail = ins.spread_pips + ' pips (max ' + (ins.max_spread_pips || 4) + ')';
    }
    setCheckDyn('chk-spread', checks.spread_acceptable, spreadDetail);

    // Pullback
    var pullDetail = '—';
    if (ins.ema9 !== undefined) {
      pullDetail = 'EMA(9): ' + ins.ema9 + ' / Δ: ' + ins.price_vs_ema;
    }
    setCheckDyn('chk-pullback', checks.pullback_to_ema, pullDetail);

    // Confirmation pattern
    var confDetail = '—';
    if (ins.signal) confDetail = ins.signal.reason;
    else if (ins.result === 'no_confirmation_pattern') confDetail = 'No pattern found';
    setCheckDyn('chk-confirm', checks.confirmation_pattern, confDetail);

    // SL valid
    var slDetail = '—';
    if (ins.sl !== undefined) slDetail = ins.sl.toFixed(2);
    else if (ins.result === 'sl_out_of_bounds') slDetail = 'SL outside bounds';
    setCheckDyn('chk-sl', checks.sl_valid, slDetail);

    // Risk
    var riskDetail = '—';
    if (ins.signal && ins.sl !== undefined && ins.tp !== undefined) {
      riskDetail = ins.signal.direction.toUpperCase() + ' @ ' + ins.signal.entry_price.toFixed(2) +
        ' SL:' + ins.sl.toFixed(2) + ' TP:' + ins.tp.toFixed(2);
    }
    setCheckDyn('chk-risk', checks.risk_calculated, riskDetail);
  }

  function renderScalpDetails(ins, el) {
    var html = '';

    // Multi-timeframe trend — single cycling row, click row to expand all
    var tfOrder = ['S5', 'M1', 'M5', 'M15', 'M30', 'H1'];
    var mtf = ins.multi_tf_trends || {};
    html += '<div style="color:#8b949e; font-size:12px; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">Trend Analysis</div>';
    html += '<div id="tf-trend-list"' + (_tfExpanded ? ' class="tf-expanded"' : '') + '>';
    for (var ti = 0; ti < tfOrder.length; ti++) {
      var tf = tfOrder[ti];
      var tfd = mtf[tf] || {};
      var dir = tfd.direction || 'unknown';
      var cls = dir === 'bullish' ? 'tf-bullish' : dir === 'bearish' ? 'tf-bearish' : dir === 'flat' ? 'tf-flat' : 'tf-unknown';
      var arrow = dir === 'bullish' ? '▲' : dir === 'bearish' ? '▼' : dir === 'flat' ? '▬' : '?';
      var vis = _tfExpanded ? ' tf-visible' : (ti === (_tfCycleIdx % tfOrder.length)) ? ' tf-visible' : '';
      html += '<div class="tf-trend-row' + vis + '" data-tf="' + tf + '" onclick="window._toggleTfExpand()" style="cursor:pointer;">';
      html += '<span class="tf-trend-label mono">' + tf + '</span>';
      html += '<span class="tf-trend-dir mono ' + cls + '">' + arrow + ' ' + dir.toUpperCase() + '</span>';
      html += '</div>';
    }
    html += '</div>';

    // Primary bias values (always visible)
    if (ins.trend) {
      html += '<div style="margin-top:8px; padding-top:6px; border-top:1px solid #21262d;">';
      html += '<div class="insight-stat"><span class="insight-stat-label">Bias: latest</span>' +
        '<span class="insight-stat-value mono">' + ins.trend.ema_fast + '</span></div>';
      html += '<div class="insight-stat"><span class="insight-stat-label">Bias: window start</span>' +
        '<span class="insight-stat-value mono">' + ins.trend.ema_slow + '</span></div>';
      html += '</div>';
    }

    // Latest candle
    html += '<div style="margin-top:12px; color:#8b949e; font-size:12px; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px;">Latest M1 Candle</div>';
    if (ins.latest_candle) {
      var c = ins.latest_candle;
      var prec = 2;
      html += '<div class="insight-stat"><span class="insight-stat-label">Price</span>' +
        '<span class="insight-stat-value mono">' + c.close.toFixed(prec) + '</span></div>';
      html += '<div class="insight-stat"><span class="insight-stat-label">OHLC</span>' +
        '<span class="insight-stat-value mono">O:' + c.open.toFixed(prec) + ' H:' + c.high.toFixed(prec) + ' L:' + c.low.toFixed(prec) + '</span></div>';
    }

    // Signal if found
    if (ins.signal) {
      html += '<div style="margin-top:12px; color:#8b949e; font-size:12px; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px;">Signal</div>';
      var sigColor = ins.signal.direction === 'buy' ? '#3fb950' : '#f85149';
      html += '<div class="insight-stat"><span class="insight-stat-label">Direction</span>' +
        '<span class="insight-stat-value mono" style="color:' + sigColor + '">' + ins.signal.direction.toUpperCase() + '</span></div>';
      html += '<div class="insight-stat"><span class="insight-stat-label">Entry</span>' +
        '<span class="insight-stat-value mono">' + ins.signal.entry_price.toFixed(2) + '</span></div>';
      if (ins.sl !== undefined) html += '<div class="insight-stat"><span class="insight-stat-label">SL</span><span class="insight-stat-value mono">' + ins.sl.toFixed(2) + '</span></div>';
      if (ins.tp !== undefined) html += '<div class="insight-stat"><span class="insight-stat-label">TP</span><span class="insight-stat-value mono">' + ins.tp.toFixed(2) + '</span></div>';
      if (ins.rr_ratio) html += '<div class="insight-stat"><span class="insight-stat-label">R:R</span><span class="insight-stat-value mono">1:' + ins.rr_ratio + '</span></div>';
    }

    // Spread
    if (ins.spread_pips !== undefined) {
      html += '<div style="margin-top:12px;"><div class="insight-stat"><span class="insight-stat-label">Est. Spread</span>' +
        '<span class="insight-stat-value mono">' + ins.spread_pips + ' pips</span></div></div>';
    }

    el.innerHTML = html;
  }

  // ── Poll Loop ────────────────────────────────────────────

  function updateAccount(data) {
    var acct = data.account;
    if (!acct) return;

    // Overwrite equity & balance with live OANDA values
    if (acct.equity != null) $('equity').textContent = fmt$(acct.equity);
    if (acct.balance != null) $('balance').textContent = fmt$(acct.balance);

    // Unrealised P&L metric
    var upnl = acct.unrealized_pnl || 0;
    var upnlEl = $('unrealized-pnl');
    if (upnlEl) {
      upnlEl.textContent = (upnl >= 0 ? '+' : '') + fmt$(upnl);
      upnlEl.className = 'metric-value mono ' + pnlClass(upnl);
    }

    // Equity delta (equity minus balance)
    if (acct.equity != null && acct.balance != null) {
      var delta = acct.equity - acct.balance;
      var el = $('equity-delta');
      el.textContent = (delta >= 0 ? '+' : '') + fmt$(delta);
      el.className = 'metric-sub mono ' + pnlClass(delta);
    }

    // Open positions count
    var posEl = $('open-pos-count');
    if (posEl && acct.open_position_count != null) {
      posEl.textContent = acct.open_position_count;
    }
  }

  function poll() {
    Promise.all([
      fetchJSON('/status'),
      fetchJSON('/positions'),
      fetchJSON('/signals/pending'),
      fetchJSON('/trades/closed?limit=20'),
      fetchJSON('/strategy/insight'),
      fetchJSON('/signals/history'),
      fetchJSON('/account')
    ]).then(function(results) {
      updateStatus(results[0]);
      updatePositions(results[1]);
      updateWatchlist(results[2]);
      updateClosedTrades(results[3]);
      updateInsight(results[4]);
      updateSignalLog(results[5]);
      updateAccount(results[6]);
      $('last-refresh').textContent = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone:'UTC'}) + ' UTC';
    }).catch(function(err) {
      console.error('Poll error:', err);
    });
  }

  // Initial poll, then repeat
  poll();
  setInterval(poll, POLL_MS);

  // ── Timeframe trend cycling timer ────────────────────────
  var _tfCycleOrder = ['S5', 'M1', 'M5', 'M15', 'M30', 'H1'];
  var _tfCycleIdx = 0;
  var _tfExpanded = false;
  window._toggleTfExpand = function() {
    _tfExpanded = !_tfExpanded;
    var list = document.getElementById('tf-trend-list');
    if (!list) return;
    if (_tfExpanded) {
      list.classList.add('tf-expanded');
    } else {
      list.classList.remove('tf-expanded');
    }
  };
  setInterval(function() {
    if (_tfExpanded) return; // don't cycle when expanded
    var list = document.getElementById('tf-trend-list');
    if (!list) return;
    var rows = list.querySelectorAll('.tf-trend-row');
    if (rows.length === 0) return;
    // Hide all rows
    for (var r = 0; r < rows.length; r++) rows[r].classList.remove('tf-visible');
    // Advance and show one
    _tfCycleIdx = (_tfCycleIdx + 1) % _tfCycleOrder.length;
    var target = list.querySelector('[data-tf="' + _tfCycleOrder[_tfCycleIdx] + '"]');
    if (target) target.classList.add('tf-visible');
  }, 3000);

  // Load current settings once
  fetchJSON('/settings').then(function(data) {
    if (data.risk_per_trade_pct != null) $('set-risk').value = data.risk_per_trade_pct;
    if (data.rr_ratio != null) $('set-rr').value = data.rr_ratio;
    if (data.max_drawdown_pct != null) $('set-dd').value = data.max_drawdown_pct;
    if (data.session_start_utc != null) $('set-sess-start').value = data.session_start_utc;
    if (data.session_end_utc != null) $('set-sess-end').value = data.session_end_utc;
    if (data.max_concurrent_positions != null) $('set-max-pos').value = data.max_concurrent_positions;
    if (data.poll_interval_seconds != null) $('set-poll').value = data.poll_interval_seconds;
  }).catch(function() {});

})();
</script>
</body>
</html>
